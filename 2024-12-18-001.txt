# Ensure AzureAD module is installed
# If not installed, run: Install-Module -Name AzureAD

# Connect to Azure AD
Connect-AzureAD

# Array of role names to check
$targetRoles = @(
    "Global Administrator",
    "Privileged Role Administrator",
    "User Administrator",
    "SharePoint Administrator",
    "Exchange Administrator",
    "Hybrid Identity Administrator",
    "Application Administrator",
    "Cloud Application Administrator"
)

# Initialize results array
$results = @()

# Get all directory roles
$directoryRoles = Get-AzureADDirectoryRole

foreach ($role in $directoryRoles) {
    # Check if this role is one we're interested in
    if ($targetRoles -contains $role.DisplayName) {
        # Get members of this role
        $members = Get-AzureADDirectoryRoleMember -ObjectId $role.ObjectId
        
        foreach ($member in $members) {
            # Create custom object with relevant information
            $results += [PSCustomObject]@{
                RoleName = $role.DisplayName
                MemberType = if ($member.ObjectType -eq "User") { "User" } else { "Group" }
                DisplayName = $member.DisplayName
                UserPrincipalName = if ($member.UserPrincipalName) { $member.UserPrincipalName } else { "N/A" }
                ObjectId = $member.ObjectId
                Enabled = if ($member.AccountEnabled -ne $null) { $member.AccountEnabled } else { "N/A" }
            }
        }
    }
}

# Export results to CSV
$results | Export-Csv -Path "AzureADAdminRoles_$(Get-Date -Format 'yyyyMMdd').csv" -NoTypeInformation

# Display results in console
$results | Format-Table -AutoSize -Wrap

# Disconnect from Azure AD
Disconnect-AzureAD